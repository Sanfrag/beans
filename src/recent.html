<!DOCTYPE html>

<html>
  <head>
    <script>
      /** @type {typeof import("fs")} */
      const fs = nw.require("fs");
      /** @type {typeof import("path")} */
      const path = nw.require("path");

      const isAlt =
        btoa(path.basename(window.location.pathname)) ===
        "cGVhZHJpdmVTdG9yYWdlLmh0bWw=";

      let saving = false;
      let workspacePath = path.join(
        nw.App.dataPath,
        isAlt ? "WorkspaceDrive" : "WorkspaceFS"
      );

      function go() {
        if (isAlt) {
          window.addEventListener("message", onMessageWrapped, false);
        } else {
          window.addEventListener("message", onMessage, false);
        }

        window.parent.postMessage(
          JSON.stringify({ code: "ready", prm: true, secret: "READY" }),
          "*"
        );
      }

      function encodeRecentFilename(filename) {
        const dirname = path.dirname(filename).replace(/\/|\\/g, "\u2CC6");
        const basename = path.basename(filename);
        return `${basename}\u2003${dirname}\u2CC6${basename}`;
      }

      function decodeRecentFilename(filename) {
        const parts = filename.split("\u2003");
        if (parts.length != 2) return filename;
        const path = parts[1].replace(/\u2CC6/g, "/");
        return path;
      }

      function removeFile(prm) {
        if (prm == "/Recent" || prm == "/Workspace") {
          send("0", "");
          send("1", "This is a special folder and can not be deleted");
          return;
        }

        if (prm.startsWith("/Recent")) {
          prm = decodeRecentFilename(prm.slice(8));

          let recent = nw.global.localStorage.getItem("recentFiles");
          try {
            recent = JSON.parse(recent);
          } catch {
            recent = [];
          }
          if (!Array.isArray(recent)) {
            recent = [];
          }

          const predelete = recent.length;
          recent = recent.filter((p) => p.path !== prm);
          send("0", "");
          if (predelete != recent.length) {
            nw.global.localStorage.setItem(
              "recentFiles",
              JSON.stringify(recent)
            );
            send(
              "1",
              "Removed a history entry. (The content file is not deleted)"
            );
          }
        } else if (prm.startsWith("/Workspace")) {
          prm = path.join(workspacePath, prm.slice(11));
          fs.rm(prm, { recursive: true, force: true }, (err) => {
            if (err) {
              send("0", "");
              send("1", err.message);
              return;
            }
            send("0", "");
          });
        } else {
          send("0", "");
        }
      }

      function renameFile(prm) {
        if (prm.startsWith("/Recent")) {
          send("0", "");
          send("1", "Can not rename recent history");
          return;
        } else if (prm.startsWith("/Workspace")) {
          const parts = prm.split(":");
          if (parts.length != 2) {
            send("0", "");
            send("1", 'Can not rename filenames containing ":"');
            return;
          }

          const oldName = parts[0].slice(11);
          const newName = parts[1];

          const oldPath = path.join(workspacePath, oldName);
          const newPath = path.join(path.dirname(oldPath), newName);

          fs.rename(oldPath, newPath, (err) => {
            if (err) {
              send("0", "");
              send("1", err.message);
              return;
            }
            send("0", "");
          });
        } else {
          send("0", "");
        }
      }

      function listRecent() {
        let recent = nw.global.localStorage.getItem("recentFiles");
        try {
          recent = JSON.parse(recent);
        } catch {
          recent = [];
        }
        if (!Array.isArray(recent)) {
          recent = [];
        }

        const list = recent
          .map((p) => {
            try {
              const stat = fs.statSync(p.path);
              return [encodeRecentFilename(p.path), stat.size, p.time, null];
            } catch (e) {
              return null;
            }
          })
          .filter(Boolean);

        if (recent.length != list.length) {
          nw.global.localStorage.setItem(
            "recentFiles",
            JSON.stringify(list.map((entry) => decodeRecentFilename(entry[0])))
          );
        }

        send("0", list);
      }

      function listWorkspace(prm) {
        if (!prm.startsWith("/Workspace")) {
          send("0", []);
          return;
        }

        // check if workspacePath exists
        if (!fs.existsSync(workspacePath)) {
          fs.mkdirSync(workspacePath, { recursive: true });
        }

        const p = path.join(workspacePath, prm.slice(11));
        try {
          const list = fs.readdirSync(p);
          send(
            "0",
            list.map((e) => {
              try {
                const stat = fs.statSync(path.join(p, e));
                if (stat.isDirectory()) {
                  return [e, -1];
                } else {
                  return [e, stat.size, ~~(stat.mtimeMs / 1000)];
                }
              } catch (e) {
                return null;
              }
            })
          );
        } catch (e) {
          send("0", []);
        }
      }

      function list(prm) {
        if (prm == "/") {
          send("0", [
            ["Recent", -1, 1],
            ["Workspace", -1, 0],
          ]);
          return;
        }

        if (prm == "/Recent") {
          listRecent();
          return;
        } else if (prm.startsWith("/Workspace")) {
          listWorkspace(prm);
          return;
        } else {
          send("0", []);
          return;
        }
      }

      function openFile(prm) {
        if (prm.startsWith("/Recent")) {
          prm = decodeRecentFilename(prm.slice(8));
        } else if (prm.startsWith("/Workspace")) {
          prm = path.join(workspacePath, prm.slice(11));
        } else {
          window.parent.postMessage(Buffer.from([]), "*");
          send("1", "Invalid file path");
          return;
        }

        fs.readFile(prm, (err, data) => {
          if (err) {
            window.parent.postMessage(Buffer.from([]), "*");
            send("1", err.message);
            return;
          }

          nw.global.recordRecent(prm);
          window.parent.postMessage(data.buffer, "*");
        });
      }

      function saveFile(prm, data) {
        if (prm.startsWith("/Recent")) {
          prm = decodeRecentFilename(prm.slice(8));
          let recent = nw.global.localStorage.getItem("recentFiles");
          try {
            recent = JSON.parse(recent);
          } catch {
            recent = [];
          }
          if (!Array.isArray(recent)) {
            recent = [];
          }
          if (!recent.some((p) => p.path === prm)) {
            send("0", "");
            send("1", "Can not save to recent history");
            return;
          }
        } else if (prm.startsWith("/Workspace")) {
          prm = prm.slice(11);
          const dirname = path.dirname(prm);
          const filename = path.basename(
            decodeRecentFilename(path.basename(prm))
          );
          prm = path.join(workspacePath, dirname, filename);
        } else {
          send("0", "");
          send("1", "Can not save to this location");
          return;
        }

        const buffer = Buffer.from(new Uint8Array(data));

        fs.writeFile(prm, buffer, (err) => {
          if (err) {
            send("0", "");
            send("1", err.message);
            return;
          }
          send("0", "");
        });
      }

      function createFolder(prm) {
        if (prm.startsWith("/Workspace")) {
          prm = path.join(workspacePath, prm.slice(11));
          fs.mkdir(prm, { recursive: true }, (err) => {
            if (err) {
              send("0", "");
              send("1", err.message);
              return;
            }
            send("0", "");
          });
        } else {
          send("0", "");
          send("1", "Can not create folder here");
        }
      }

      function onMessage(e) {
        if (typeof e.data == "string") {
          let msg = null;
          try {
            msg = JSON.parse(e.data);
          } catch (e) {
            return;
          }

          if (!msg || msg.code == null) return;

          if (msg.code == "show") {
            list(msg.prm);
            return;
          } else if (msg.code == "load") {
            openFile(msg.prm);
            return;
          } else if (msg.code == "save") {
            if (msg.prm.endsWith("/")) {
              createFolder(msg.prm);
              return;
            }
            saving = msg.prm;
            return;
          } else if (msg.code == "delete") {
            removeFile(msg.prm);
            return;
          } else if (msg.code == "rename") {
            renameFile(msg.prm);
            return;
          }
          send("0", "");
        } else if (saving) {
          saveFile(saving, e.data);
          saving = false;
        }
      }

      function onMessageWrapped(e) {
        if (typeof e.data == "string") {
          let msg = null;
          try {
            msg = JSON.parse(e.data);
          } catch (e) {
            onMessage(e);
            return;
          }

          if (!msg || msg.code == null) return;

          if (msg.prm && msg.prm.startsWith("/")) {
            msg.prm = "/Workspace" + msg.prm;
            onMessage({ data: JSON.stringify(msg) });
            return;
          } else {
            onMessage(e);
            return;
          }
        } else {
          onMessage(e);
          return;
        }
      }

      function send(code, prm) {
        var str = JSON.stringify({ code: code, prm: prm });
        window.parent.postMessage(str, "*");
      }
    </script>
  </head>
  <body onload="go()"></body>
</html>
